<ng-container *ngIf="isHrUser || isManagerUser || isEmployeeUser; else noAccess">
  <section class="landing-surface">
    <header class="section-header">
      <div>
        <p class="eyebrow">{{ isManagerUser ? 'Manager' : (isEmployeeUser ? 'Employee' : 'HR') }} / {{ sectionLabel() }}</p>
        <h1>{{ sectionLabel() }}</h1>
        <p class="subcopy" *ngIf="activeSection() === 'employees'">Centralize hiring, transfers, and org mapping from a single source of truth.</p>
        <p class="subcopy" *ngIf="activeSection() === 'appraisals'">Assign due employees to managers and start appraisal workflow.</p>
        <p class="subcopy" *ngIf="activeSection() === 'upcoming'">Review assigned appraisal cases and read employee information.</p>
        <p class="subcopy" *ngIf="activeSection() === 'comments'">Capture achievements, gaps, and suggestions for the selected employee.</p>
        <p class="subcopy" *ngIf="activeSection() === 'finalize'">Finalize appraisal outcomes and submit CTC details for the selected employee.</p>
        <p class="subcopy" *ngIf="activeSection() === 'reports'">View upcoming, in-process, and completed appraisal reports with role-limited data.</p>
        <p class="subcopy" *ngIf="activeSection() === 'access'">Activate, deactivate, and assign roles for users from the employee directory.</p>
        <p class="subcopy" *ngIf="activeSection() === 'my-appraisal'">Review appraisal assigned to you and read manager comments.</p>
        <p class="subcopy" *ngIf="activeSection() === 'feedback'">Submit your feedback after reviewing manager comments.</p>
        <p class="subcopy" *ngIf="activeSection() !== 'employees' && activeSection() !== 'appraisals' && activeSection() !== 'upcoming' && activeSection() !== 'comments' && activeSection() !== 'finalize' && activeSection() !== 'reports' && activeSection() !== 'access' && activeSection() !== 'my-appraisal' && activeSection() !== 'feedback'">This module is coming soon. Switch back to Manage Employee to keep working.</p>
      </div>
      <div class="section-actions" *ngIf="activeSection() === 'employees' && showForm()">
        <button class="ghost" type="button" (click)="onFormCancel()">Back to listing</button>
      </div>
    </header>

    <ng-container [ngSwitch]="activeSection()">
      <div *ngSwitchCase="'employees'" class="panel">
        <app-employee-form
          *ngIf="showForm()"
          [employee]="formModel()"
          (save)="onFormSubmit($event)"
          (cancel)="onFormCancel()">
        </app-employee-form>

        <ng-container *ngIf="!showForm()">
          <app-employee-table
            [employees]="employees()"
            [loading]="loading()"
            [error]="error()"
            (add)="onAddEmployee()">
          </app-employee-table>
        </ng-container>
      </div>

      <div *ngSwitchCase="'appraisals'" class="panel">
        <app-appraisal-assignment
          [candidates]="appraisalCandidates()"
          [loading]="appraisalLoading()"
          [error]="appraisalError()"
          [canAssign]="true"
          (assign)="onAssignAppraisal($event)">
        </app-appraisal-assignment>
      </div>

      <div *ngSwitchCase="'reports'" class="panel comments-panel">
        <p class="save-error" *ngIf="reportsLoading()">Loading reports…</p>
        <p class="save-error" *ngIf="!reportsLoading() && reportsError()">{{ reportsError() }}</p>

        <div class="readonly-comments" *ngIf="!reportsLoading() && !reportsError()">
          <h3>Upcoming Appraisals</h3>
          <div class="report-table-wrap" *ngIf="reportUpcoming().length; else noUpcoming">
            <table class="report-table">
              <thead>
                <tr>
                  <th>Appraisal ID</th>
                  <th>Cycle</th>
                  <th>Employee</th>
                  <th>Manager</th>
                  <th>Status</th>
                  <th>Cycle End</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of reportUpcoming()">
                  <td>{{ row.appraisalId }}</td>
                  <td>{{ row.cycleName || '—' }}</td>
                  <td>{{ row.employeeName || '—' }}</td>
                  <td>{{ row.managerName || '—' }}</td>
                  <td>{{ row.status || '—' }}</td>
                  <td>{{ row.cycleEndDate | date: 'dd-MMM-yyyy' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noUpcoming>
            <p class="save-error">No upcoming appraisals found.</p>
          </ng-template>
        </div>

        <div class="readonly-comments" *ngIf="!reportsLoading() && !reportsError()">
          <h3>In-Process Appraisals</h3>
          <div class="report-table-wrap" *ngIf="reportInProcess().length; else noInProcess">
            <table class="report-table">
              <thead>
                <tr>
                  <th>Appraisal ID</th>
                  <th>Cycle</th>
                  <th>Employee</th>
                  <th>Manager</th>
                  <th>Status</th>
                  <th>Cycle End</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of reportInProcess()">
                  <td>{{ row.appraisalId }}</td>
                  <td>{{ row.cycleName || '—' }}</td>
                  <td>{{ row.employeeName || '—' }}</td>
                  <td>{{ row.managerName || '—' }}</td>
                  <td>{{ row.status || '—' }}</td>
                  <td>{{ row.cycleEndDate | date: 'dd-MMM-yyyy' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noInProcess>
            <p class="save-error">No in-process appraisals found.</p>
          </ng-template>
        </div>

        <div class="readonly-comments" *ngIf="!reportsLoading() && !reportsError()">
          <h3>Completed Appraisals</h3>
          <div class="report-table-wrap" *ngIf="reportCompleted().length; else noCompleted">
            <table class="report-table">
              <thead>
                <tr>
                  <th>Appraisal ID</th>
                  <th>Cycle</th>
                  <th>Employee</th>
                  <th>Manager</th>
                  <th>Status</th>
                  <th>Finalized At</th>
                  <th *ngIf="reportHasDetailedCtc()">Total CTC</th>
                  <th *ngIf="reportHasDetailedCtc()">Currency</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of reportCompleted()">
                  <td>{{ row.appraisalId }}</td>
                  <td>{{ row.cycleName || '—' }}</td>
                  <td>{{ row.employeeName || '—' }}</td>
                  <td>{{ row.managerName || '—' }}</td>
                  <td>{{ row.status || '—' }}</td>
                  <td>{{ row.finalizedAt | date: 'dd-MMM-yyyy HH:mm' }}</td>
                  <td *ngIf="reportHasDetailedCtc()">{{ row.totalCtc ?? '—' }}</td>
                  <td *ngIf="reportHasDetailedCtc()">{{ row.currency || '—' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <ng-template #noCompleted>
            <p class="save-error">No completed appraisals found.</p>
          </ng-template>
        </div>
      </div>

      <div *ngSwitchCase="'upcoming'" class="panel upcoming-panel">
        <app-appraisal-assignment
          [candidates]="appraisalCandidates()"
          [loading]="appraisalLoading()"
          [error]="appraisalError()"
          [canAssign]="false"
          [enableDetails]="true"
          (viewDetails)="onViewUpcomingCandidate($event)">
        </app-appraisal-assignment>

        <div class="inline-popup-backdrop" *ngIf="upcomingProfilePopupOpen()">
          <div class="profile-card inline-popup" *ngIf="selectedUpcomingCandidate() as selected">
            <div class="profile-header">
              <h3>Employee Personal Info</h3>
              <button type="button" class="ghost" (click)="closeUpcomingProfilePopup()">Close</button>
            </div>
            <div class="profile-grid">
              <p><strong>Name:</strong> {{ selected.employeeName }}</p>
              <p><strong>Employee ID:</strong> {{ selected.employeeId }}</p>
              <p><strong>Email:</strong> {{ selected.employeeEmail }}</p>
              <p><strong>Department:</strong> {{ selected.departmentName || '—' }}</p>
              <p><strong>Reports To:</strong> {{ selected.reportsToName || selected.assignedManagerName || '—' }}</p>
              <p><strong>Cycle:</strong> {{ selected.cycleName || '—' }}</p>
              <p><strong>Status:</strong> {{ selected.assignmentStatus || '—' }}</p>
              <p><strong>Due Date:</strong> {{ selected.dueDate | date: 'dd-MMM-yyyy' }}</p>
              <p><strong>Mobile:</strong> {{ selectedUpcomingEmployeeProfile()?.mobile || '—' }}</p>
              <p><strong>Phone:</strong> {{ selectedUpcomingEmployeeProfile()?.phone || '—' }}</p>
              <p><strong>City:</strong> {{ selectedUpcomingEmployeeProfile()?.city || '—' }}</p>
              <p><strong>Date of Joining:</strong> {{ selectedUpcomingEmployeeProfile()?.doj || '—' }}</p>
            </div>
          </div>
        </div>
      </div>

      <div *ngSwitchCase="'access'" class="panel comments-panel">
        <p class="save-ok" *ngIf="accessSaveMessage()">{{ accessSaveMessage() }}</p>
        <p class="save-error" *ngIf="accessSaveError()">{{ accessSaveError() }}</p>

        <app-employee-table
          [employees]="employees()"
          [loading]="loading()"
          [error]="error()"
          [showAddButton]="false"
          [showAccessActions]="true"
          [userActiveState]="userActiveStates()"
          (statusToggle)="onUserStatusToggle($event)"
          (assignRole)="openAssignRoleDialog($event)">
        </app-employee-table>

        <div class="access-dialog-backdrop" *ngIf="accessDialogOpen()">
          <div class="access-dialog">
            <h3>Assign Role</h3>
            <p class="dialog-subtitle" *ngIf="selectedAccessEmployee() as user">
              {{ user.name }} ({{ user.email }})
            </p>

            <p class="save-error" *ngIf="accessRolesLoading()">Loading roles…</p>

            <div class="roles-list" *ngIf="!accessRolesLoading()">
              <label *ngFor="let role of accessRoles()" class="role-option">
                <input
                  type="checkbox"
                  [checked]="selectedRoleIds().includes(role.id)"
                  (change)="toggleRoleSelection(role.id, $any($event.target).checked)" />
                <span>{{ role.name }}</span>
              </label>

              <p class="dialog-note">Leave all roles unchecked to revoke all roles for this user.</p>
            </div>

            <div class="dialog-actions">
              <button type="button" class="ghost" (click)="closeAccessDialog()">Cancel</button>
              <button type="button" class="primary" (click)="saveAssignedRoles()">Save</button>
            </div>
          </div>
        </div>
      </div>

      <div *ngSwitchCase="'comments'" class="panel comments-panel">
        <div class="comments-grid">
          <label>
            Select Employee
            <select [ngModel]="selectedCommentEmployeeId()" (ngModelChange)="onCommentEmployeeChange($event)">
              <option [ngValue]="null">Choose assigned appraisal</option>
              <option *ngFor="let item of managerAssignedCandidates()" [ngValue]="item.employeeId">
                {{ item.employeeName }} ({{ item.employeeEmail }})
              </option>
            </select>
          </label>

          <div class="readonly-comments" *ngIf="selectedCommentEmployeeId() && selectedCommentEmployeeProfile() as profile">
            <h3>Employee Personal Info</h3>
            <div class="profile-grid">
              <p><strong>Name:</strong> {{ profile.name || '—' }}</p>
              <p><strong>Employee ID:</strong> {{ profile.id || '—' }}</p>
              <p><strong>Email:</strong> {{ profile.email || '—' }}</p>
              <p><strong>Department:</strong> {{ profile.departmentName || profile.orgUnitCode || '—' }}</p>
              <p><strong>Reports To:</strong> {{ profile.reportsToName || profile.reportsToId || profile.managerId || '—' }}</p>
              <p><strong>Mobile:</strong> {{ profile.mobile || '—' }}</p>
              <p><strong>Phone:</strong> {{ profile.phone || '—' }}</p>
              <p><strong>City:</strong> {{ profile.city || '—' }}</p>
              <p><strong>Date of Joining:</strong> {{ profile.doj || '—' }}</p>
              <p><strong>Date of Birth:</strong> {{ profile.dob || '—' }}</p>
            </div>
          </div>

          <label>
            Achievements
            <textarea rows="4" [ngModel]="achievements()" (ngModelChange)="onAchievementsChange($event)"></textarea>
          </label>

          <label>
            Things Not Achieved
            <textarea rows="4" [ngModel]="notAchieved()" (ngModelChange)="onNotAchievedChange($event)"></textarea>
          </label>

          <label>
            Suggestions
            <textarea rows="4" [ngModel]="suggestions()" (ngModelChange)="onSuggestionsChange($event)"></textarea>
          </label>
        </div>

        <div class="comments-actions">
          <button type="button" (click)="saveManagerComments()">Save Comments</button>
          <p class="save-ok" *ngIf="commentsSaveMessage()">{{ commentsSaveMessage() }}</p>
          <p class="save-error" *ngIf="commentsSaveError()">{{ commentsSaveError() }}</p>
        </div>

        <div class="readonly-comments" *ngIf="selectedCommentEmployeeId()">
          <h3>Conversation (Manager + Employee)</h3>
          <p class="save-error" *ngIf="commentsThreadLoading()">Loading conversation…</p>
          <p *ngIf="!commentsThreadLoading() && !commentsThread().length" class="save-error">No comments available for this appraisal yet.</p>
          <article *ngFor="let comment of commentsThread()" class="comment-card">
            <p>{{ comment.commentText }}</p>
            <small>{{ resolveCommentAuthor(comment) }} • {{ comment.createdAt | date: 'dd-MMM-yyyy HH:mm' }}</small>
          </article>
        </div>

      </div>

      <div *ngSwitchCase="'finalize'" class="panel comments-panel">
        <div class="readonly-comments" *ngIf="finalizeSelectedAppraisalId()">
          <h3>Finalized CTC (Read-only)</h3>
          <p class="save-error" *ngIf="finalizedCtcLoading()">Loading finalized CTC…</p>
          <p class="save-error" *ngIf="!finalizedCtcLoading() && finalizedCtcError()">{{ finalizedCtcError() }}</p>
          <p class="save-error" *ngIf="!finalizedCtcLoading() && !finalizedCtcError() && !finalizedCtc()">No finalized CTC found yet for this appraisal.</p>
          <article class="comment-card" *ngIf="!finalizedCtcLoading() && finalizedCtc() as ctc">
            <p><strong>Total CTC:</strong> {{ ctc.ctcAmount }}</p>
            <small>Saved on {{ ctc.createdAt | date: 'dd-MMM-yyyy HH:mm' }}</small>
          </article>
        </div>

        <div class="comments-grid">
          <label>
            Select Assigned Appraisal
            <select [ngModel]="finalizeSelectedAppraisalId()" (ngModelChange)="onFinalizeAppraisalChange($event)">
              <option [ngValue]="null">Choose appraisal</option>
              <option *ngFor="let item of finalizeEligibleCandidates()" [ngValue]="item.assignmentId">
                {{ item.employeeName }} - {{ item.cycleName }}
              </option>
            </select>
            <small *ngIf="finalizeEligibilityLoading()" class="save-error">Checking manager comments…</small>
            <small *ngIf="!finalizeEligibilityLoading() && managerAssignedCandidates().length && !finalizeEligibleCandidates().length" class="save-error">
              No appraisal is ready for finalization. Save manager comments first.
            </small>
          </label>

          <label>
            Promotion Decision
            <select [ngModel]="finalizePromotion()" (ngModelChange)="finalizePromotion.set($event)">
              <option value="">Choose decision</option>
              <option value="YES">Yes</option>
              <option value="NO">No</option>
            </select>
          </label>

          <label>
            Currency
            <select [ngModel]="finalizeCurrency()" (ngModelChange)="finalizeCurrency.set($event || '')">
              <option value="">Choose currency</option>
              <option *ngFor="let code of finalizeCurrencyOptions()" [value]="code">{{ code }}</option>
            </select>
          </label>

          <label>
            Basic
            <input type="number" min="0" [ngModel]="finalizeBasic()" (ngModelChange)="finalizeBasic.set($event == null || $event === '' ? null : +$event)" />
          </label>

          <label>
            DA
            <input type="number" min="0" [ngModel]="finalizeDa()" (ngModelChange)="finalizeDa.set($event == null || $event === '' ? null : +$event)" />
          </label>

          <label>
            HRA
            <input type="number" min="0" [ngModel]="finalizeHra()" (ngModelChange)="finalizeHra.set($event == null || $event === '' ? null : +$event)" />
          </label>

          <label>
            Food Allowance
            <input type="number" min="0" [ngModel]="finalizeFoodAllowance()" (ngModelChange)="finalizeFoodAllowance.set($event == null || $event === '' ? null : +$event)" />
          </label>

          <label>
            PF
            <input type="number" min="0" [ngModel]="finalizePf()" (ngModelChange)="finalizePf.set($event == null || $event === '' ? null : +$event)" />
          </label>

          <label>
            Next Appraisal Date
            <input type="date" [ngModel]="finalizeNextAppraisalDate()" (ngModelChange)="finalizeNextAppraisalDate.set($event || '')" />
          </label>
        </div>

        <div class="comments-actions">
          <button type="button" (click)="saveFinalizeAndCtc()" [disabled]="finalizeSaving()">Save Finalization</button>
          <p class="save-ok" *ngIf="finalizeMessage()">{{ finalizeMessage() }}</p>
          <p class="save-error" *ngIf="finalizeError()">{{ finalizeError() }}</p>
        </div>
      </div>

      <div *ngSwitchCase="'my-appraisal'" class="panel comments-panel">
        <div class="comments-grid">
          <label>
            Select My Appraisal
            <select [ngModel]="selectedEmployeeAppraisalId()" (ngModelChange)="onEmployeeAppraisalChange($event)">
              <option [ngValue]="null">Choose appraisal</option>
              <option *ngFor="let item of employeeAssignedCandidates()" [ngValue]="item.assignmentId">
                {{ item.employeeName }} - {{ item.cycleName }}
              </option>
            </select>
          </label>

          <div class="readonly-comments">
            <h3>Manager Comments (Read-only)</h3>
            <p *ngIf="!managerComments().length" class="save-error">Comments not yet available. Please check later.</p>
            <article *ngFor="let comment of managerComments()" class="comment-card">
              <p>{{ comment.commentText }}</p>
              <small>{{ comment.createdAt | date: 'dd-MMM-yyyy HH:mm' }}</small>
            </article>
          </div>
        </div>
      </div>

      <div *ngSwitchCase="'feedback'" class="panel comments-panel">
        <div class="comments-grid">
          <label>
            Select My Appraisal
            <select [ngModel]="selectedEmployeeAppraisalId()" (ngModelChange)="onEmployeeAppraisalChange($event)">
              <option [ngValue]="null">Choose appraisal</option>
              <option *ngFor="let item of employeeAssignedCandidates()" [ngValue]="item.assignmentId">
                {{ item.employeeName }} - {{ item.cycleName }}
              </option>
            </select>
          </label>

          <div class="readonly-comments">
            <h3>Manager Comments (Read-only)</h3>
            <p *ngIf="!managerComments().length" class="save-error">Comments not yet available. Feedback is disabled until manager comments are available.</p>
            <p *ngIf="feedbackLockedAfterFinal()" class="save-error">This appraisal is finalized. Feedback submission is closed.</p>
            <article *ngFor="let comment of managerComments()" class="comment-card">
              <p>{{ comment.commentText }}</p>
              <small>{{ comment.createdAt | date: 'dd-MMM-yyyy HH:mm' }}</small>
            </article>
          </div>

          <label>
            My Feedback
            <textarea rows="5" [ngModel]="employeeFeedbackText()" (ngModelChange)="onEmployeeFeedbackChange($event)" [disabled]="!managerComments().length || feedbackLockedAfterFinal()"></textarea>
          </label>
        </div>

        <div class="comments-actions">
          <button type="button" (click)="submitEmployeeFeedback()" [disabled]="!managerComments().length || feedbackLockedAfterFinal()">Submit Feedback</button>
          <p class="save-ok" *ngIf="employeeFeedbackMessage()">{{ employeeFeedbackMessage() }}</p>
          <p class="save-error" *ngIf="employeeFeedbackError()">{{ employeeFeedbackError() }}</p>
        </div>
      </div>

      <div *ngSwitchDefault class="panel placeholder">
        <h2>{{ sectionLabel() }}</h2>
        <p>We're shaping this workspace right now. Check back later or keep managing employees.</p>
        <button type="button" (click)="goToSection('employees')">Back to Manage Employee</button>
      </div>
    </ng-container>
  </section>
</ng-container>

<ng-template #noAccess>
  <section class="landing-surface locked">
    <div class="panel placeholder">
      <h2>Restricted</h2>
      <p>You need HR access to view this workspace.</p>
      <button type="button" routerLink="/login">Return to login</button>
    </div>
  </section>
</ng-template>
