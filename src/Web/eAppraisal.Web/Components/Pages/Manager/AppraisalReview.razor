@page "/manager/appraisal/{Id:int}"
@rendermode InteractiveServer
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = AppRoles.Manager)]
@inject AppraisalService AppraisalSvc
@inject NavigationManager Nav

<PageTitle>Appraisal Review — Manager</PageTitle>

<div class="container py-3" style="max-width:700px">
    <div class="d-flex align-items-center mb-3">
        <button class="btn btn-sm btn-outline-secondary me-2" @onclick='() => Nav.NavigateTo("/manager/my-team")'>
            <i class="bi bi-arrow-left"></i>
        </button>
        <h3 class="mb-0"><i class="bi bi-clipboard2-check me-2 text-primary"></i>Appraisal Review</h3>
    </div>

    @if (_loading)
    {
        <div class="text-center py-5"><span class="spinner-border text-primary"></span></div>
    }
    else if (_appraisal is null)
    {
        <div class="alert alert-danger">Appraisal not found.</div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(_message))
        {
            <div class="alert @(_success ? "alert-success" : "alert-danger") d-flex gap-2">
                <i class="bi @(_success ? "bi-check-circle" : "bi-exclamation-triangle")"></i>@_message
            </div>
        }

        <!-- Appraisal summary card -->
        <div class="card shadow-sm mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-bold fs-5">@_appraisal.EmployeeName</span>
                <span class="badge @StatusBadge(_appraisal.Status)">@_appraisal.Status</span>
            </div>
            <div class="card-body row g-2 small">
                <div class="col-6"><strong>Department:</strong> @_appraisal.EmployeeDepartment</div>
                <div class="col-6"><strong>Year:</strong> @_appraisal.Year</div>
                <div class="col-6"><strong>Manager:</strong> @_appraisal.ManagerName</div>
                <div class="col-6"><strong>Initiated:</strong> @_appraisal.InitiatedAt.ToString("dd MMM yyyy")</div>
                @if (_appraisal.CompletedAt.HasValue)
                {
                    <div class="col-6"><strong>Completed:</strong> @_appraisal.CompletedAt.Value.ToString("dd MMM yyyy")</div>
                }
            </div>
        </div>

        <!-- Employee self-assessment (read-only for manager) -->
        @if (!string.IsNullOrEmpty(_appraisal.SelfAssessmentInput))
        {
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info bg-opacity-10 fw-semibold">
                    <i class="bi bi-person me-1 text-info"></i>Employee Self-Assessment
                </div>
                <div class="card-body">
                    <p class="mb-0" style="white-space:pre-wrap">@_appraisal.SelfAssessmentInput</p>
                </div>
            </div>
        }

        <!-- Manager comment input -->
        @if (_appraisal.Status == "AwaitingManagerComment")
        {
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-warning bg-opacity-10 fw-semibold">
                    <i class="bi bi-chat-quote me-1 text-warning"></i>Your Comment
                </div>
                <div class="card-body">
                    <textarea @bind="_managerComment" class="form-control" rows="5"
                              placeholder="Enter your professional assessment and feedback..."></textarea>
                    <div class="mt-3">
                        <button class="btn btn-primary" @onclick="SubmitCommentAsync" disabled="@_saving">
                            @if (_saving) { <span class="spinner-border spinner-border-sm me-1"></span> }
                            <i class="bi bi-send me-1"></i>Submit Comment &amp; Forward to Employee
                        </button>
                    </div>
                </div>
            </div>
        }

        <!-- Display existing manager comment -->
        @if (!string.IsNullOrEmpty(_appraisal.ManagerComments) && _appraisal.Status != "AwaitingManagerComment")
        {
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-warning bg-opacity-10 fw-semibold">
                    <i class="bi bi-chat-quote me-1 text-warning"></i>Manager Comment (Submitted)
                </div>
                <div class="card-body">
                    <p class="mb-0" style="white-space:pre-wrap">@_appraisal.ManagerComments</p>
                </div>
            </div>
        }

        <!-- Final assessment input -->
        @if (_appraisal.Status == "AwaitingFinalAssessment")
        {
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary bg-opacity-10 fw-semibold">
                    <i class="bi bi-award me-1 text-primary"></i>Final Assessment
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Final Remarks</label>
                        <textarea @bind="_finalAssessment" class="form-control" rows="5"
                                  placeholder="Provide your final assessment and conclusions..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Rating (1–5)</label>
                        <InputSelect @bind-Value="_rating" class="form-select" style="max-width:150px">
                            @for (int r = 1; r <= 5; r++)
                            {
                                <option value="@r">@r — @RatingLabel(r)</option>
                            }
                        </InputSelect>
                    </div>
                    <button class="btn btn-success" @onclick="SubmitFinalAsync" disabled="@_saving">
                        @if (_saving) { <span class="spinner-border spinner-border-sm me-1"></span> }
                        <i class="bi bi-check-all me-1"></i>Complete Appraisal
                    </button>
                </div>
            </div>
        }

        <!-- Final assessment display -->
        @if (!string.IsNullOrEmpty(_appraisal.FinalAssessment))
        {
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success bg-opacity-10 fw-semibold">
                    <i class="bi bi-award me-1 text-success"></i>Final Assessment (Completed)
                </div>
                <div class="card-body">
                    <p style="white-space:pre-wrap">@_appraisal.FinalAssessment</p>
                    @if (_appraisal.Rating.HasValue)
                    {
                        <span class="badge bg-warning text-dark fs-6">Rating: @_appraisal.Rating/5 ⭐</span>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    private AppraisalDto? _appraisal;
    private bool _loading = true;
    private string _message = string.Empty;
    private bool _success, _saving;
    private string _managerComment = string.Empty;
    private string _finalAssessment = string.Empty;
    private int _rating = 3;

    protected override async Task OnInitializedAsync()
    {
        _appraisal = await AppraisalSvc.GetByIdAsync(Id);
        if (_appraisal?.ManagerComments is not null)
            _managerComment = _appraisal.ManagerComments;
        _loading = false;
    }

    private async Task SubmitCommentAsync()
    {
        if (string.IsNullOrWhiteSpace(_managerComment)) { _message = "Comment cannot be empty."; _success = false; return; }
        _saving = true;
        var (ok, msg) = await AppraisalSvc.SubmitManagerCommentAsync(Id, _managerComment);
        _message = msg; _success = ok;
        if (ok) { _appraisal = await AppraisalSvc.GetByIdAsync(Id); }
        _saving = false;
    }

    private async Task SubmitFinalAsync()
    {
        if (string.IsNullOrWhiteSpace(_finalAssessment)) { _message = "Final assessment cannot be empty."; _success = false; return; }
        _saving = true;
        var (ok, msg) = await AppraisalSvc.SubmitFinalAssessmentAsync(Id, _finalAssessment, _rating);
        _message = msg; _success = ok;
        if (ok) { _appraisal = await AppraisalSvc.GetByIdAsync(Id); }
        _saving = false;
    }

    private static string StatusBadge(string s) => s switch
    {
        "AwaitingManagerComment"  => "bg-warning text-dark",
        "AwaitingEmployeeInput"   => "bg-info text-dark",
        "AwaitingFinalAssessment" => "bg-primary",
        "Completed"               => "bg-success",
        _                         => "bg-secondary"
    };

    private static string RatingLabel(int r) => r switch
    {
        1 => "Needs Improvement",
        2 => "Below Expectations",
        3 => "Meets Expectations",
        4 => "Exceeds Expectations",
        5 => "Outstanding",
        _ => ""
    };
}
